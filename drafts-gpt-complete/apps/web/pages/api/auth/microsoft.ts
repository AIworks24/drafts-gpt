import type { NextApiRequest, NextApiResponse } from 'next';
import { msalApp } from '@/lib/auth';
import { supabase } from '@/lib/supabase';
export default async function handler(req:NextApiRequest,res:NextApiResponse){if(req.method!=='GET')return res.status(405).end();const code=req.query.code as string;if(!code)return res.status(400).json({error:'Missing code'});try{const token=await msalApp.acquireTokenByCode({code,scopes:['offline_access','openid','profile','Mail.Read','Mail.ReadWrite','Calendars.Read'],redirectUri:process.env.OAUTH_REDIRECT_URI!});const upn=token.account?.username||'';const tenant=token.tenantId||'';const access=token.accessToken||'';const refresh=(token as any).refreshToken||'';if(!upn)throw new Error('No UPN on token');const {error}=await supabase.from('m365_users').upsert({upn,account_tenant:tenant,access_token_encrypted:access,refresh_token_encrypted:refresh},{onConflict:'upn'});if(error)throw error;res.redirect('/dashboard');}catch(e:any){console.error(e);res.status(500).json({error:e.message});}}