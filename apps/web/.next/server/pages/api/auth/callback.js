"use strict";(()=>{var e={};e.id=712,e.ids=[712],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},709:e=>{e.exports=import("@azure/msal-node")},6113:e=>{e.exports=require("crypto")},6835:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},2944:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{config:()=>l,default:()=>u,routeModule:()=>p});var a=r(9150),i=r(1631),s=r(6835),o=r(3434),c=e([o]);o=(c.then?(await c)():c)[0];let u=(0,s.l)(o,"default"),l=(0,s.l)(o,"config"),p=new a.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/auth/callback",pathname:"/api/auth/callback",bundlePath:"",filename:""},userland:o});n()}catch(e){n(e)}})},1277:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.d(t,{LL:()=>c,Oh:()=>s,rW:()=>u});var a=r(709),i=e([a]);a=(i.then?(await i)():i)[0];let o=`https://login.microsoftonline.com/${process.env.AZURE_TENANT_ID}`,c=new a.ConfidentialClientApplication({auth:{clientId:process.env.AZURE_CLIENT_ID,clientSecret:process.env.AZURE_CLIENT_SECRET,authority:o},system:{loggerOptions:{logLevel:2}}}),u=["openid","profile","offline_access","https://graph.microsoft.com/Mail.Read","https://graph.microsoft.com/Mail.ReadWrite","https://graph.microsoft.com/Calendars.Read"];function s(e){let t={scopes:u,redirectUri:process.env.AZURE_REDIRECT_URI,state:e,prompt:"select_account"};return c.getAuthCodeUrl(t)}n()}catch(e){n(e)}})},4087:(e,t,r)=>{r.d(t,{Ov:()=>l,Gg:()=>u,py:()=>p,KY:()=>c});var n=r(6113);let a=require("cookie"),i="dgpt_sess",s=process.env.SESSION_SECRET;if(!s||s.length<32)throw Error("SESSION_SECRET too short");function o(e){return(0,n.createHash)("sha256").update(s+e).digest("hex")}function c(e,t){let r=JSON.stringify(t),n=o(r);e.setHeader("Set-Cookie",(0,a.serialize)(i,Buffer.from(r).toString("base64")+"."+n,{httpOnly:!0,sameSite:"lax",path:"/",secure:!0,maxAge:2592e3}))}function u(e){let t=(0,a.parse)(e.headers.cookie||"")[i];if(!t)return null;let[r,n]=t.split("."),s=Buffer.from(r||"","base64").toString();return o(s)!==n?null:JSON.parse(s)}function l(e){e.setHeader("Set-Cookie",(0,a.serialize)(i,"",{path:"/",maxAge:0}))}function p(){return(0,n.randomBytes)(16).toString("hex")}},2512:(e,t,r)=>{r.d(t,{O:()=>s});let n=require("@supabase/supabase-js"),a=process.env.SUPABASE_URL,i=process.env.SUPABASE_SERVICE_ROLE_KEY||process.env.SUPABASE_ANON_KEY;if(!a)throw Error("Missing SUPABASE_URL");if(!i)throw Error("Missing SUPABASE_SERVICE_ROLE_KEY or SUPABASE_ANON_KEY");let s=(0,n.createClient)(a,i,{auth:{persistSession:!1}})},3434:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{default:()=>c});var a=r(1277),i=r(4087),s=r(2512),o=e([a]);async function c(e,t){let r=e.query.code;if(!r)return t.status(400).send("Missing code");let n=await a.LL.acquireTokenByCode({code:r,scopes:a.rW,redirectUri:process.env.AZURE_REDIRECT_URI}),o=n?.idTokenClaims,c=(o?.preferred_username||o?.upn||"").toLowerCase(),u=o?.tid||"unknown",l=o?.name||c,{data:p}=await s.O.from("app_users").upsert({upn:c,tenant_id:u,display_name:l},{onConflict:"upn"}).select().single(),d=JSON.parse(a.LL.getTokenCache().serialize());await s.O.from("msal_token_cache").upsert({user_id:p.id,cache_json:d}),(0,i.KY)(t,{userId:p.id}),t.redirect("/dashboard")}a=(o.then?(await o)():o)[0],n()}catch(e){n(e)}})},1631:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},9150:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=2944);module.exports=r})();