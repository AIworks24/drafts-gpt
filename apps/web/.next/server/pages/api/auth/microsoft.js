"use strict";(()=>{var e={};e.id=646,e.ids=[646],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},709:e=>{e.exports=import("@azure/msal-node")},6835:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},4729:(e,r,t)=>{t.a(e,async(e,n)=>{try{t.r(r),t.d(r,{config:()=>u,default:()=>E,routeModule:()=>_});var o=t(9150),s=t(1631),i=t(6835),a=t(9956),c=e([a]);a=(c.then?(await c)():c)[0];let E=(0,i.l)(a,"default"),u=(0,i.l)(a,"config"),_=new o.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/auth/microsoft",pathname:"/api/auth/microsoft",bundlePath:"",filename:""},userland:a});n()}catch(e){n(e)}})},3660:(e,r,t)=>{t.a(e,async(e,n)=>{try{t.d(r,{LL:()=>E});var o=t(709),s=e([o]);o=(s.then?(await s)():s)[0];let i=process.env.AZURE_TENANT_ID||"common",a=`https://login.microsoftonline.com/${i}`,c=process.env.AZURE_REDIRECT_URI||process.env.OAUTH_REDIRECT_URI||"";if(!process.env.AZURE_CLIENT_ID)throw Error("Missing AZURE_CLIENT_ID");if(!process.env.AZURE_CLIENT_SECRET)throw Error("Missing AZURE_CLIENT_SECRET");if(!c)throw Error("Missing AZURE_REDIRECT_URI or OAUTH_REDIRECT_URI");let E=new o.ConfidentialClientApplication({auth:{clientId:process.env.AZURE_CLIENT_ID,clientSecret:process.env.AZURE_CLIENT_SECRET,authority:a}});n()}catch(e){n(e)}})},2512:(e,r,t)=>{t.d(r,{O:()=>i});let n=require("@supabase/supabase-js"),o=process.env.SUPABASE_URL,s=process.env.SUPABASE_SERVICE_ROLE_KEY||process.env.SUPABASE_ANON_KEY;if(!o)throw Error("Missing SUPABASE_URL");if(!s)throw Error("Missing SUPABASE_SERVICE_ROLE_KEY or SUPABASE_ANON_KEY");let i=(0,n.createClient)(o,s,{auth:{persistSession:!1}})},9956:(e,r,t)=>{t.a(e,async(e,n)=>{try{t.r(r),t.d(r,{default:()=>a});var o=t(3660),s=t(2512),i=e([o]);async function a(e,r){if("GET"!==e.method)return r.status(405).end();let t=e.query.code;if(!t)return r.status(400).json({error:"Missing code"});try{let e=await o.LL.acquireTokenByCode({code:t,scopes:["offline_access","openid","profile","Mail.Read","Mail.ReadWrite","Calendars.Read"],redirectUri:process.env.OAUTH_REDIRECT_URI}),n=e.account?.username||"",i=e.tenantId||"",a=e.accessToken||"",c=e.refreshToken||"";if(!n)throw Error("No UPN on token");let{error:E}=await s.O.from("m365_users").upsert({upn:n,account_tenant:i,access_token_encrypted:a,refresh_token_encrypted:c},{onConflict:"upn"});if(E)throw E;r.redirect("/dashboard")}catch(e){console.error(e),r.status(500).json({error:e.message})}}o=(i.then?(await i)():i)[0],n()}catch(e){n(e)}})},1631:(e,r)=>{var t;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},9150:(e,r,t)=>{e.exports=t(145)}};var r=require("../../../webpack-api-runtime.js");r.C(e);var t=r(r.s=4729);module.exports=t})();