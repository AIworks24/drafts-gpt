"use strict";(()=>{var e={};e.id=929,e.ids=[929],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},709:e=>{e.exports=import("@azure/msal-node")},6113:e=>{e.exports=require("crypto")},6835:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},5211:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.r(t),r.d(t,{config:()=>p,default:()=>u,routeModule:()=>l});var o=r(9150),s=r(1631),n=r(6835),a=r(6184),c=e([a]);a=(c.then?(await c)():c)[0];let u=(0,n.l)(a,"default"),p=(0,n.l)(a,"config"),l=new o.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/graph/subscribe",pathname:"/api/graph/subscribe",bundlePath:"",filename:""},userland:a});i()}catch(e){i(e)}})},1277:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.d(t,{LL:()=>c,Oh:()=>n,rW:()=>u});var o=r(709),s=e([o]);o=(s.then?(await s)():s)[0];let a=`https://login.microsoftonline.com/${process.env.AZURE_TENANT_ID}`,c=new o.ConfidentialClientApplication({auth:{clientId:process.env.AZURE_CLIENT_ID,clientSecret:process.env.AZURE_CLIENT_SECRET,authority:a},system:{loggerOptions:{logLevel:2}}}),u=["openid","profile","offline_access","https://graph.microsoft.com/Mail.Read","https://graph.microsoft.com/Mail.ReadWrite","https://graph.microsoft.com/Calendars.Read"];function n(e){let t={scopes:u,redirectUri:process.env.AZURE_REDIRECT_URI,state:e,prompt:"select_account"};return c.getAuthCodeUrl(t)}i()}catch(e){i(e)}})},4087:(e,t,r)=>{r.d(t,{Ov:()=>p,Gg:()=>u,py:()=>l,KY:()=>c});var i=r(6113);let o=require("cookie"),s="dgpt_sess",n=process.env.SESSION_SECRET;if(!n||n.length<32)throw Error("SESSION_SECRET too short");function a(e){return(0,i.createHash)("sha256").update(n+e).digest("hex")}function c(e,t){let r=JSON.stringify(t),i=a(r);e.setHeader("Set-Cookie",(0,o.serialize)(s,Buffer.from(r).toString("base64")+"."+i,{httpOnly:!0,sameSite:"lax",path:"/",secure:!0,maxAge:2592e3}))}function u(e){let t=(0,o.parse)(e.headers.cookie||"")[s];if(!t)return null;let[r,i]=t.split("."),n=Buffer.from(r||"","base64").toString();return a(n)!==i?null:JSON.parse(n)}function p(e){e.setHeader("Set-Cookie",(0,o.serialize)(s,"",{path:"/",maxAge:0}))}function l(){return(0,i.randomBytes)(16).toString("hex")}},2512:(e,t,r)=>{r.d(t,{O:()=>n});let i=require("@supabase/supabase-js"),o=process.env.SUPABASE_URL,s=process.env.SUPABASE_SERVICE_ROLE_KEY||process.env.SUPABASE_ANON_KEY;if(!o)throw Error("Missing SUPABASE_URL");if(!s)throw Error("Missing SUPABASE_SERVICE_ROLE_KEY or SUPABASE_ANON_KEY");let n=(0,i.createClient)(o,s,{auth:{persistSession:!1}})},6184:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.r(t),r.d(t,{default:()=>u});var o=r(4087),s=r(2512),n=r(1277),a=r(6113),c=e([n]);async function u(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method Not Allowed"});let r=(0,o.Gg)(e);if(!r)return t.status(401).json({error:"Not signed in"});let{data:i}=await s.O.from("app_users").select().eq("id",r.userId).single();if(!i)return t.status(404).json({error:"User not found"});let{data:c}=await s.O.from("msal_token_cache").select().eq("user_id",i.id).single();if(!c)return t.status(400).json({error:"No token cache"});n.LL.getTokenCache().deserialize(JSON.stringify(c.cache_json));let u=await n.LL.acquireTokenSilent({account:(await n.LL.getTokenCache().getAllAccounts())[0],scopes:n.rW}),p=(0,a.randomBytes)(12).toString("hex"),l=new Date(Date.now()+864e5-3e5),d=await fetch("https://graph.microsoft.com/v1.0/subscriptions",{method:"POST",headers:{Authorization:`Bearer ${u.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({changeType:"created,updated",notificationUrl:`${process.env.WEBHOOK_BASE_URL}/api/graph/webhook`,resource:"/me/messages",clientState:p,expirationDateTime:l.toISOString()})});if(!d.ok)return t.status(500).json({error:"Subscription failed",detail:await d.text()});let f=await d.json();await s.O.from("graph_subscriptions").upsert({id:f.id,user_id:i.id,client_state:p,resource:f.resource,expiration_time:f.expirationDateTime}),t.status(200).json({ok:!0,subscriptionId:f.id,expiration:f.expirationDateTime})}n=(c.then?(await c)():c)[0],i()}catch(e){i(e)}})},1631:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},9150:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=5211);module.exports=r})();