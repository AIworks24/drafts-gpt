"use strict";(()=>{var e={};e.id=640,e.ids=[640],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},709:e=>{e.exports=import("@azure/msal-node")},2079:e=>{e.exports=import("openai")},6835:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},360:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>u,default:()=>l,routeModule:()=>p});var n=a(9150),o=a(1631),i=a(6835),s=a(54),c=e([s]);s=(c.then?(await c)():c)[0];let l=(0,i.l)(s,"default"),u=(0,i.l)(s,"config"),p=new n.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/graph/webhook",pathname:"/api/graph/webhook",bundlePath:"",filename:""},userland:s});r()}catch(e){r(e)}})},7400:(e,t,a)=>{a.d(t,{TT:()=>l,p6:()=>o,rP:()=>c});let r=process.env.GRAPH_BASE||"https://graph.microsoft.com/v1.0";async function n(e){let t=await e.text();try{return JSON.parse(t)}catch{return t}}async function o(e,t){let a=await fetch(`${r}${t}`,{headers:{Authorization:`Bearer ${e}`}});if(!a.ok)throw Error(`GET ${t} ${a.status} ${await a.text()}`);return a.json()}async function i(e,t,a){let o=await fetch(`${r}${t}`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:a?JSON.stringify(a):void 0});if(!o.ok)throw Error(`POST ${t} ${o.status} ${await n(o)}`);return o.json()}async function s(e,t,a){let o=await fetch(`${r}${t}`,{method:"PATCH",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!o.ok&&204!==o.status)throw Error(`PATCH ${t} ${o.status} ${await n(o)}`);return 204===o.status?null:o.json()}async function c(e,t,a=!1){return i(e,`/me/messages/${t}/${a?"createReplyAll":"createReply"}`)}async function l(e,t,a){return s(e,`/me/messages/${t}`,{body:{contentType:"html",content:a}})}},1277:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.d(t,{LL:()=>c,Oh:()=>i,rW:()=>l});var n=a(709),o=e([n]);n=(o.then?(await o)():o)[0];let s=`https://login.microsoftonline.com/${process.env.AZURE_TENANT_ID}`,c=new n.ConfidentialClientApplication({auth:{clientId:process.env.AZURE_CLIENT_ID,clientSecret:process.env.AZURE_CLIENT_SECRET,authority:s},system:{loggerOptions:{logLevel:2}}}),l=["openid","profile","offline_access","https://graph.microsoft.com/Mail.Read","https://graph.microsoft.com/Mail.ReadWrite","https://graph.microsoft.com/Calendars.Read"];function i(e){let t={scopes:l,redirectUri:process.env.AZURE_REDIRECT_URI,state:e,prompt:"select_account"};return c.getAuthCodeUrl(t)}r()}catch(e){r(e)}})},1289:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.d(t,{R:()=>i});var n=a(2079),o=e([n]);let s=new(n=(o.then?(await o)():o)[0]).default({apiKey:process.env.OPENAI_API_KEY});async function i(e){let t=`
Thread summary:
${e.threadSummary}

Brand voice (optional):
${e.brandVoice||"neutral, professional"}

Draft a reply email body (HTML <p> and basic tags).`,a=await s.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:"You draft professional email replies. Keep it concise, polite, and actionable. HTML only (no inline CSS)."},{role:"user",content:t}],temperature:.4});return a.choices[0]?.message?.content?.trim()||"<p>Thank you for your email.</p>"}r()}catch(e){r(e)}})},2512:(e,t,a)=>{a.d(t,{O:()=>i});let r=require("@supabase/supabase-js"),n=process.env.SUPABASE_URL,o=process.env.SUPABASE_SERVICE_ROLE_KEY||process.env.SUPABASE_ANON_KEY;if(!n)throw Error("Missing SUPABASE_URL");if(!o)throw Error("Missing SUPABASE_SERVICE_ROLE_KEY or SUPABASE_ANON_KEY");let i=(0,r.createClient)(n,o,{auth:{persistSession:!1}})},54:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>u,default:()=>l});var n=a(2512),o=a(1277),i=a(7400),s=a(1289),c=e([o,s]);[o,s]=c.then?(await c)():c;let u={api:{bodyParser:{sizeLimit:"1mb"}}};async function l(e,t){if("GET"===e.method)return function(e,t){let a=e.query.validationToken;return a?t.status(200).send(a):t.status(400).send("Missing validationToken")}(e,t);if("POST"!==e.method)return t.status(405).json({error:"Method Not Allowed"});t.status(202).json({ok:!0});try{let t=e.body;for(let e of t?.value||[]){if("reauthorizationRequired"===e.lifecycleEvent)continue;let{data:t}=await n.O.from("graph_subscriptions").select().eq("id",e.subscriptionId).single();if(!t||t.client_state!==e.clientState)continue;let{data:a}=await n.O.from("msal_token_cache").select().eq("user_id",t.user_id).single();if(!a)continue;o.LL.getTokenCache().deserialize(JSON.stringify(a.cache_json));let r=(await o.LL.getTokenCache().getAllAccounts())[0];if(!r)continue;let c=await o.LL.acquireTokenSilent({account:r,scopes:o.rW}).catch(()=>null);if(!c?.accessToken)continue;let l=e.resourceData?.id;if(!l)continue;let u=await (0,i.p6)(c.accessToken,`/me/messages/${l}`),p=`Subject: ${u.subject||""}
From: ${u.from?.emailAddress?.address||""}
Preview: ${u.bodyPreview||""}`,d=await (0,s.R)({threadSummary:p}),f=await (0,i.rP)(c.accessToken,l,!1);await (0,i.TT)(c.accessToken,f.id,d)}}catch(e){console.error("webhook error",e)}}r()}catch(e){r(e)}})},1631:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},9150:(e,t,a)=>{e.exports=a(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=360);module.exports=a})();