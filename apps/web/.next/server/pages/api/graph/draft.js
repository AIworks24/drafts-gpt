"use strict";(()=>{var e={};e.id=666,e.ids=[666],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},709:e=>{e.exports=import("@azure/msal-node")},2079:e=>{e.exports=import("openai")},6113:e=>{e.exports=require("crypto")},6835:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},7298:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>l,default:()=>u,routeModule:()=>p});var n=r(9150),o=r(1631),s=r(6835),i=r(7797),c=e([i]);i=(c.then?(await c)():c)[0];let u=(0,s.l)(i,"default"),l=(0,s.l)(i,"config"),p=new n.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/graph/draft",pathname:"/api/graph/draft",bundlePath:"",filename:""},userland:i});a()}catch(e){a(e)}})},7400:(e,t,r)=>{r.d(t,{TT:()=>u,p6:()=>o,rP:()=>c});let a=process.env.GRAPH_BASE||"https://graph.microsoft.com/v1.0";async function n(e){let t=await e.text();try{return JSON.parse(t)}catch{return t}}async function o(e,t){let r=await fetch(`${a}${t}`,{headers:{Authorization:`Bearer ${e}`}});if(!r.ok)throw Error(`GET ${t} ${r.status} ${await r.text()}`);return r.json()}async function s(e,t,r){let o=await fetch(`${a}${t}`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:r?JSON.stringify(r):void 0});if(!o.ok)throw Error(`POST ${t} ${o.status} ${await n(o)}`);return o.json()}async function i(e,t,r){let o=await fetch(`${a}${t}`,{method:"PATCH",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(r)});if(!o.ok&&204!==o.status)throw Error(`PATCH ${t} ${o.status} ${await n(o)}`);return 204===o.status?null:o.json()}async function c(e,t,r=!1){return s(e,`/me/messages/${t}/${r?"createReplyAll":"createReply"}`)}async function u(e,t,r){return i(e,`/me/messages/${t}`,{body:{contentType:"html",content:r}})}},1277:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{LL:()=>c,Oh:()=>s,rW:()=>u});var n=r(709),o=e([n]);n=(o.then?(await o)():o)[0];let i=`https://login.microsoftonline.com/${process.env.AZURE_TENANT_ID}`,c=new n.ConfidentialClientApplication({auth:{clientId:process.env.AZURE_CLIENT_ID,clientSecret:process.env.AZURE_CLIENT_SECRET,authority:i},system:{loggerOptions:{logLevel:2}}}),u=["openid","profile","offline_access","https://graph.microsoft.com/Mail.Read","https://graph.microsoft.com/Mail.ReadWrite","https://graph.microsoft.com/Calendars.Read"];function s(e){let t={scopes:u,redirectUri:process.env.AZURE_REDIRECT_URI,state:e,prompt:"select_account"};return c.getAuthCodeUrl(t)}a()}catch(e){a(e)}})},1289:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{R:()=>s});var n=r(2079),o=e([n]);let i=new(n=(o.then?(await o)():o)[0]).default({apiKey:process.env.OPENAI_API_KEY});async function s(e){let t=`
Thread summary:
${e.threadSummary}

Brand voice (optional):
${e.brandVoice||"neutral, professional"}

Draft a reply email body (HTML <p> and basic tags).`,r=await i.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:"You draft professional email replies. Keep it concise, polite, and actionable. HTML only (no inline CSS)."},{role:"user",content:t}],temperature:.4});return r.choices[0]?.message?.content?.trim()||"<p>Thank you for your email.</p>"}a()}catch(e){a(e)}})},4087:(e,t,r)=>{r.d(t,{Ov:()=>l,Gg:()=>u,py:()=>p,KY:()=>c});var a=r(6113);let n=require("cookie"),o="dgpt_sess",s=process.env.SESSION_SECRET;if(!s||s.length<32)throw Error("SESSION_SECRET too short");function i(e){return(0,a.createHash)("sha256").update(s+e).digest("hex")}function c(e,t){let r=JSON.stringify(t),a=i(r);e.setHeader("Set-Cookie",(0,n.serialize)(o,Buffer.from(r).toString("base64")+"."+a,{httpOnly:!0,sameSite:"lax",path:"/",secure:!0,maxAge:2592e3}))}function u(e){let t=(0,n.parse)(e.headers.cookie||"")[o];if(!t)return null;let[r,a]=t.split("."),s=Buffer.from(r||"","base64").toString();return i(s)!==a?null:JSON.parse(s)}function l(e){e.setHeader("Set-Cookie",(0,n.serialize)(o,"",{path:"/",maxAge:0}))}function p(){return(0,a.randomBytes)(16).toString("hex")}},2512:(e,t,r)=>{r.d(t,{O:()=>s});let a=require("@supabase/supabase-js"),n=process.env.SUPABASE_URL,o=process.env.SUPABASE_SERVICE_ROLE_KEY||process.env.SUPABASE_ANON_KEY;if(!n)throw Error("Missing SUPABASE_URL");if(!o)throw Error("Missing SUPABASE_SERVICE_ROLE_KEY or SUPABASE_ANON_KEY");let s=(0,a.createClient)(n,o,{auth:{persistSession:!1}})},7797:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>l});var n=r(4087),o=r(2512),s=r(1277),i=r(7400),c=r(1289),u=e([s,c]);async function l(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method Not Allowed"});let{messageId:r}=e.body||{};if(!r)return t.status(400).json({error:"messageId required"});let a=(0,n.Gg)(e);if(!a)return t.status(401).json({error:"Not signed in"});let{data:u}=await o.O.from("msal_token_cache").select().eq("user_id",a.userId).single();if(!u)return t.status(400).json({error:"No token cache"});s.LL.getTokenCache().deserialize(JSON.stringify(u.cache_json));let l=(await s.LL.getTokenCache().getAllAccounts())[0];if(!l)return t.status(400).json({error:"No account"});let p=await s.LL.acquireTokenSilent({account:l,scopes:s.rW}),d=await (0,i.p6)(p.accessToken,`/me/messages/${r}`),f=`Subject: ${d.subject||""}
From: ${d.from?.emailAddress?.address||""}
Preview: ${d.bodyPreview||""}`,h=await (0,c.R)({threadSummary:f}),m=await (0,i.rP)(p.accessToken,r,!1);await (0,i.TT)(p.accessToken,m.id,h),t.status(200).json({ok:!0,draftId:m.id})}[s,c]=u.then?(await u)():u,a()}catch(e){a(e)}})},1631:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},9150:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=7298);module.exports=r})();